<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mapbox API Exercises</title>
    <!-- Bootstrap stylesheet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <!-- Mapbox stuff -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        .marker {
            background-image: url('img/marker.svg.png');
            background-size: cover;
            width: 20px;
            height: 30px;
            cursor: pointer;
        }
        .popup-img {
            /*width: 15vw;*/
            height: 10vh;
            float: left;
        }
    </style>
</head>
<body class="container justify-content-center">
<h1>Best Restaurants</h1>
<div class="container-fluid" id='map' style='width: 80vw; height: 80vh;'></div>
<section class="d-flex m-4">
    <div class="container">
        <button class="btn btn-secondary" id="mapzoom-in">Zoom in</button>
        <button class="btn btn-secondary" id="mapzoom-out">Zoom out</button>
    </div>
    <div class="input-group flex-fill">
        <input type="text" class="form-control" id="mapcoord-input" placeholder="latitude, longitude" aria-label="latitude and longitude" aria-describedby="goto-coordinates">
        <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" id="mapcoord-submit">Go to</button>
        </div>
    </div>
</section>
<footer>
    <p>Map marker icon source:
        <a href="https://commons.wikimedia.org/wiki/File:Map_marker.svg">Andrew Onorato, modified by User:Psubhashish</a>, <a href="https://creativecommons.org/licenses/by-sa/3.0">CC BY-SA 3.0</a>, via Wikimedia Commons
    </p>
</footer>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
<!-- API keys -->
<script src="js/keys.js"></script>
<script src="js/mapbox-geocoder-utils.js"></script>
<!-- Mapbox map -->
<script>
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
        container: 'map', // container ID
        style: 'mapbox://styles/mapbox/streets-v11', // style URL
        center: [-98.4941816751808, 29.42989209851484], // starting position
        zoom: 9 // starting zoom
    });
</script>
<script>
    // restaurant POIs geojson source
    const restaurants = {
            'type': 'FeatureCollection',
            'features': [
                {
                    'type': 'Feature',
                    'properties': {
                        'title': 'Kungfu Noodle',
                        'description': 'Authentic Chinese noodle soup with fabulous fresh steamed bao. It\'s a dead simple setup but it\'s phenomenal food with an incredibly delicious broth. Given the choice between cutting off an arm or never going to Kungfu again, I\'d chop my arm off happily.',
                        'website': 'https://kungfu-noodle.business.site/',
                        'phone': '(210) 451-5586',
                        'image': 'img/KungfuNoodle.webp',
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [-98.618853, 29.496481000000003],
                    }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'title': 'Thai Dee',
                        'description': 'Incredible Thai food. Huge menu with tons of variety in everything from appetizers to entrees to drinks.',
                        'website': 'https://www.thaideesa.com/',
                        'phone': '(210) 342-3622',
                        'image': 'img/Thai-Dee.jpg',
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [-98.50815599999999, 29.499339000000006],
                    }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'title': 'The Magnolia Pancake Haus',
                        'description': 'Classic American breakfast food (and so much more!). Huge pancakes, great coffee, and the good butter. This restaurant feels like being at your weird old great-grandparent\'s house when you were like four years old. In a good way.',
                        'website': 'https://www.magnoliapancakehaus.com/',
                        'phone': '(210) 496-0828',
                        'image': 'img/magnolia.png',
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [-98.584856, 29.540073000000007],
                    }
                }
            ]
        };
    // add markers to map
    restaurants.features.forEach((feature) => {
        // create a HTML element for each feature
        const el = document.createElement('div');
        el.className = 'marker';

        // create popup node content
        reverseGeocode({
                'lng': feature.geometry.coordinates[0],
                'lat': feature.geometry.coordinates[1]
            }, MAPBOX_TOKEN).then((res) => {
            console.log(feature.geometry.coordinates);
            console.log(res);
            const $info = $(document.createElement('div'))
                .addClass('container justify-content-center')
                .append($(document.createElement('h5'))
                    .append($(document.createElement('a'))
                        .text(feature.properties.title)
                        .attr('href', feature.properties.website)
                        .attr('target','_blank')))
                .append($(document.createElement('img'))
                    .addClass('popup-img mr-3')
                    .attr('src', feature.properties.image))
                .append($(document.createElement('p'))
                    .addClass('mx-3')
                    .text(feature.properties.description))
                .append($(document.createElement('p'))
                    .text(res))
                .append($(document.createElement('p'))
                    .text(feature.properties.phone))

        // make a marker for each feature and add to the map
        new mapboxgl.Marker(el)
            .setLngLat(feature.geometry.coordinates)
            .setPopup(
                new mapboxgl.Popup({
                    offset: 25,
                    maxWidth: '600px',
                }) // add popups
                .setDOMContent($info.get(0))
            )
            .addTo(map);
        });
    });

    // fun extra controls w/ bootstrap stuff
    $('#mapzoom-in').on('click', function () { map.zoomIn() });
    $('#mapzoom-out').on('click', function () { map.zoomOut() });

    $('#mapcoord-submit').on('click', function () {
        let newCoords = $('#mapcoord-input').val().split(' ');
        map.flyTo({center: newCoords, speed: 1});
    });

    $('#geocoder-submit').on('click', function () {
        flyToSearch($('#geocoder-search').val());
    })

    function flyToSearch (query) {
        geocode(query, MAPBOX_TOKEN).then(function (res) {
            map.flyTo({center: res, speed: 1});
        });
    }

</script>
</body>
</html>